---
title: |
  | Black Thrive Shared Measurement System
  | Lambeth
date: "November 2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 2
    css: style.css
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(warning = FALSE)
options(scipen = 100)
```


```{r}
library(gmodels)
library(ggplot2)
library(ggrepel)
library(tidyverse)
library(kableExtra)
library(epitools)
library(scales)
library(showtext)
showtext_auto(enable = F)
# font_add("archivo",
#          regular = "../fonts/static/Archivo/Archivo-Regular.ttf",
#          italic = "../fonts/static/Archivo/Archivo-Italic.ttf",
#          bold = "../fonts/static/Archivo/Archivo-Bold.ttf",
#          bolditalic = "../fonts/static/Archivo/Archivo-BoldItalic.ttf"
# )
resolution <- 300
showtext_opts(dpi = resolution)
```


```{r rr_function}
rr_from_df <- function(df, name){
  # function takes dfs made earlier, transforms in matrices, and creates risk
  # ratios and associated confidence intervals
  # 'name' is the name of the indicator
  mat <- matrix(c(df[2,2],
                  df[2,1],
                  df[1,2],
                  df[1,1]), 2, 2)
  df_out <- data.frame("indicator" = name,
                     "rr" = riskratio(mat)[["measure"]][2,1],
                     "ci_low" = riskratio(mat)[["measure"]][2,2],
                     "ci_upp" = riskratio(mat)[["measure"]][2,3])
  return(df_out)
}

```


```{r gld, eval = FALSE}
# input stats from existing SMS
b <- data.frame("black" = c(807, 380))
w <- data.frame("white" = c(493, 101))
df <- cbind(b,w)
rownames(df) <- c("good dev","no good dev")
mat <- as.matrix(df)

gld_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_gld <- xtab # save xtab for later
rr_gld <- rr_from_df(gld_df, "Good Level of development at age 5 (2018-2019)")

```

```{r gld_new}
## good development
data <- read.csv("../data/lambeth_gld_2018_2019.csv")

total_data <- data
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

row.names(total_data) <- total_data$ethnicity # set row names for indexing

# prepare data frame for crosstabs

black <- data.frame("black" = c("gld_number" = total_data["Black", "gld"], "not_gld_number" = total_data["Black", "not_gld"]))

white <- data.frame("white" = c("gld_number" = total_data["White", "gld"], "not_gld_number" =  total_data["White", "not_gld"]))

bw_mat <- as.matrix(cbind(black, white)) # combine black and white into one matrix

gld_df <- as.data.frame(bw_mat) # save df

xtab <- CrossTable(bw_mat, fisher = T, chisq = T, expected = T) # save xtab
xtab_gld <- xtab # save for later
rr_gld <- rr_from_df(gld_df, "Good Level of development at age 5 (2018-2019)")

```


```{r gcse, eval = FALSE}
b <- data.frame("black" = c(654, 494))
w <- data.frame("white" = c(140, 83))
df <- df <- cbind(b,w)
rownames(df) <- c("Level 4+","Not level 4+")
mat <- as.matrix(df)

gcse_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_gcse <- xtab # save xtab for later
rr_gcse <- rr_from_df(gcse_df, "Level 4+ GCSE Maths & English (2018)")

```

```{r gcse_new}
data <- read.csv("../data/lambeth_gcse_2019_2020.csv")

# subset and rename
total_data <- data %>%
  subset(characteristic_gender == "Total") %>%
  rename(
    ethnicity = characteristic_Ethnic_major
  ) %>%
  subset(ethnicity == "BLACK" | ethnicity == "WHITE") %>%
  rename(gcse = t_l2basics_94,
         percent_gcse = pt_l2basics_94)

# rename ethnicity levels and row names
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")
row.names(total_data) <- total_data$ethnicity

total_data <- total_data[,-c(1)] # remove unnecessary column

# calculate number who didn't achieve level 4 plus
total_data <- total_data %>%
  mutate(
    not_gcse = t_pupils - gcse
  )

# prepare data frame for xtab
black <- data.frame("black" = c("gcse" = total_data["Black", "gcse"], "not_gcse" = total_data["Black", "not_gcse"]))
white <- data.frame("white" = c("gcse" = total_data["White", "gcse"], "not_gcse" = total_data["White", "not_gcse"]))
bw_mat <- as.matrix(cbind(black, white))

gcse_df <- as.data.frame(bw_mat) # save df

# run stats
xtab <- CrossTable(bw_mat, fisher = T, chisq = T, expected = T)
xtab_gcse <- xtab # save for later
rr_gcse <- rr_from_df(gcse_df, "Level 4+ GCSE Maths & English (2019-2020)")
```


```{r employment, eval = FALSE}
b <- data.frame("black" = c(30800,20534))
w <- data.frame("white" = c(117700,20771))
df <- cbind(b,w)
rownames(df) <- c("employed","not employed")
mat <- as.matrix(df)
chisq.test(df)

employment_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_employment <- xtab # save xtab for later
rr_employment <- rr_from_df(employment_df, "Employment rate (2020-2021)")

```

```{r employment_new}
# employment
data <- read.csv("../data/lambeth_employment_rate_march_2021_v2.csv")

# subset and organise data
total_data <- data %>%
  mutate(
    percentage = as.numeric(percentage),
    numerator = as.numeric(numerator),
    denominator = as.numeric(denominator)
  )
  
row.names(total_data) <- total_data$ethnicity

# prepare xtab
black <- data.frame("black" = c("employed" = total_data["black", "numerator"], "not_employed" = total_data["black", "not_employed"]))
white <- data.frame("white" = c("employed" = total_data["white", "numerator"], "not_employed" = total_data["white", "not_employed"]))
bw_mat <- as.matrix(cbind(black, white))

employment_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(bw_mat, fisher = T, chisq = T, expected = T)
xtab_employment <- xtab # save for later
#chisq.test(bw_mat)
rr_employment <- rr_from_df(employment_df, "Employment rate (2020-2021)")
```




```{r therapies}
b <- data.frame("black" = c(1020,550))
w <- data.frame("white" = c(1563,1563))
df <- cbind(b,w)
rownames(df) <- c("sev dep on entry","not sev dep on entry")
mat <- as.matrix(df)


talking_therapies_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_talking_therapies <- xtab # save xtab for later 
rr_therapies <- rr_from_df(talking_therapies_df, "Depressed on entry to Talking Therapies (2017-2018)")

```


```{r sect_136}
b <- data.frame("black" = c(38,63296))
w <- data.frame("white" = c(44,109956))
df <- cbind(b,w)
rownames(df) <- c("detained","not detained")
mat <- as.matrix(df)

sect_136_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_section_136 <- xtab # save xtab for later
rr_section_136 <- rr_from_df(sect_136_df, "Section 136 detentions (2018-2019)")


```



```{r restraint}
b <- data.frame("black" = c(228,123))
w <- data.frame("white" = c(70,110))
df <- cbind(b,w)
rownames(df) <- c("restraint","not restraint")
mat <- as.matrix(df)

restraint_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_restraint <- xtab # save xtab for later
rr_restraint <- rr_from_df(restraint_df, "Physical restraint in Lambeth wards (2017-2018)")


```


```{r cla, eval = FALSE}
b <- data.frame("black" = c(280,30155))
w <- data.frame("white" = c(57,14943))
df <- cbind(b,w)
rownames(df) <- c("looked after","not looked after")
mat <- as.matrix(df)

cla_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_cla <- xtab # save xtab for later

rr_cla <- rr_from_df(cla_df, "Children looked after by local authority (2018)")
```

```{r cla_new}
# children looked after
data <- read.csv("../data/lambeth_cla_2019.csv")

total_data <- data
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

row.names(total_data) <- total_data$ethnicity

# prepare xtab
black <- data.frame("black" = c("looked_after" = total_data["Black", "looked_after"], "not_looked_after" = total_data["Black", "not_looked_after"]))
white <- data.frame("white" = c("looked_after" = total_data["White", "looked_after"], "not_looked_after" = total_data["White", "not_looked_after"]))
bw_mat <- as.matrix(cbind(black, white))

cla_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(bw_mat, fisher = T, chisq = T, expected = T)
xtab_cla <- xtab # save for later
rr_cla <- rr_from_df(cla_df, "Children looked after by local authority (2018-2019)")
```


```{r temp_accomm, eval = FALSE}
b <- data.frame("black" = c(1169,31304))
w <- data.frame("white" = c(166,55168))
df <- cbind(b,w)
rownames(df) <- c("in temp accomm","not in temp accomm")
mat <- as.matrix(df)

temp_accomm_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_temp_accomm <- xtab # save xtab for later
rr_temp_accomm <- rr_from_df(temp_accomm_df, "Statutorily homeless (2018)")
```

```{r homeless_new}
# homelessness
data <- read.csv("../data/lambeth_stat_homeless_jun_2021.csv")

total_data <- data

total_data$ethnicity <- as.factor(total_data$ethnicity)
row.names(total_data) <- total_data$ethnicity

# prepare xtab
black <- data.frame("black" = c("homeless" = total_data["black", "homeless"], "not_homeless" = total_data["black", "not_homeless"]))
white <- data.frame("white" = c("homeless" = total_data["white", "homeless"], "not_homeless" = total_data["white", "not_homeless"]))
bw_mat <- as.matrix(cbind(black, white))

homelessness_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(bw_mat, fisher = T, chisq = T, expected = T)
xtab_homelessness <- xtab # save for later
#chisq.test(bw_mat)
rr_homelessness <- rr_from_df(homelessness_df, "Statutorily homeless or at risk (2020-2021)")
```


```{r stop_search, include = FALSE, eval = FALSE}
# stop and search
data <- read.csv("../data/Stops_LDS_Extract_12MonthsToEnd_202109.csv")

data <- subset(data, Borough.of.Stop == "Lambeth") # subset to Lambeth

# officer-defined ethnicity
appearance_freq_data <- data %>%
  group_by(EA.Group) %>%
  summarise(
    stopped = n() # count frequencies
  )

appearance_freq_data <- appearance_freq_data %>%
  mutate(
    pop = c(6500, 54600, 26700, 177400), # Lambeth population estimates taken from APS 12 months to Jun 2021
    percentage = 100 * (stopped/pop),
    not_stopped = pop - stopped
    ) %>%
  rename(
    ethnicity = EA.Group
  )

appearance_freq_data <- as.data.frame(appearance_freq_data)
row.names(appearance_freq_data) <- appearance_freq_data$ethnicity

black <- data.frame("Black" = c("stopped" = appearance_freq_data["Black", "stopped"], "not_stopped" = appearance_freq_data["Black", "not_stopped"]))

white <- data.frame("White" = c("stopped" = appearance_freq_data["White", "stopped"], "not_stopped" = appearance_freq_data["White", "not_stopped"]))

bw_mat <- as.matrix(cbind(black, white))

stop_search_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(bw_mat, chisq = T, fisher = T, expected = T)
xtab_stop_search <- xtab # save xtab for later
rr_stop_search <- rr_from_df(stop_search_df, "Police Stop and Search (2020-2021)")

plot_data <- subset(appearance_freq_data, ethnicity == "Black" | ethnicity == "White")

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,20), breaks = seq(0,20,5), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage of individuals \n subject to Police Stop and Search")

```


```{r stop_search_self}
# stop and search
data <- read.csv("../data/Stops_LDS_Extract_12MonthsToEnd_202108.csv")

data <- subset(data, Borough.of.Stop == "Lambeth") # subset to Lambeth

# self-defined ethnicity
self_defined_freq_data <- data %>%
  group_by(SDE.Group) %>%
  summarise(
    stopped = n() # count frequencies
  )

self_defined_freq_data <- self_defined_freq_data %>%
  mutate(
    pop = c(6500, 54600, 26700, 177400), # Lambeth population estimates taken from APS 12 months to Jun 2021
    percentage = 100 * (stopped/pop),
    not_stopped = pop - stopped
    ) %>%
  rename(
    ethnicity = SDE.Group
  )

self_defined_freq_data <- as.data.frame(self_defined_freq_data)
row.names(self_defined_freq_data) <- self_defined_freq_data$ethnicity

black <- data.frame("Black" = c("stopped" = self_defined_freq_data["Black", "stopped"], "not_stopped" = self_defined_freq_data["Black", "not_stopped"]))

white <- data.frame("White" = c("stopped" = self_defined_freq_data["White", "stopped"], "not_stopped" = self_defined_freq_data["White", "not_stopped"]))

bw_mat <- as.matrix(cbind(black, white))

stop_search_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(bw_mat, chisq = T, fisher = T, expected = T)
xtab_stop_search <- xtab # save xtab for later
rr_stop_search <- rr_from_df(stop_search_df, "Police Stop and Search (2020-2021)")
```


# Overview 

This document presents the findings for the first version of Black Thrive Global's new Shared Measurement System dashboard for Lambeth. The aim of the dashboard is to quantify racial inequality in Lambeth by comparing various indicators for the Black population with the White population. Doing so makes it possible to identify the aspects of life in Lambeth where inequality is manifest and to highlight where change is needed. By routinely reassessing these indicators, it will also be possible to track if and how these inequalities change over time.

The indicators, and the sources of their data, are presented in the Appendix.

# Procedure and Results

The data were analysed to determine whether the likelihood of each indicator outcome differed for Black versus White individuals. From this analysis is it possible to produce a relative risk ratio, which describes how much more or less likely an outcome is for the Black population compared to the White population. A ratio of exactly 1 indicates that the likelihood of the outcome is the same for both the Black population and the White population. A ratio of less than 1 indicates that the outcome is less likely for the Black population compared to the White population, and an odds ratio of more than 1 indicates the outcome is more likely for the Black population compared to the White population.

The plot below makes the results straightforward to interpret. Points to the left of the orange line indicate outcomes that are less likely for the Black population compared to the White population. Points to the right of the orange line indicate outcomes that are more likely for the Black population compared to the White population. Points that are close to the orange line (where the black bar coming from the point touches the orange line) indicate outcomes that are just as likely for the Black population as they are for the White population.

```{r or_df, include = FALSE}
# dataframe for odds ratios and cis

or_df <- data.frame("indicator" = c("Employment (2020)", 
                                 "Level 4+ GCSE Maths & English (2018)", 
                                 "Good level of development at age 5 (2017-2018)",
                                 "Statutorily homeless and in temporary accommodation (2018)",
                                 "Police Stop and Search (2020-2021)",
                                 "Children looked after by local authority (2018)",
                                 "Physical restraint in Lambeth wards (2017-2018)",
                                 "Mod./Sev. depressed on entry to Talking Therapies (2017-2018)",
                                 "Section 136 detentions (2018-2019"),
                 "OR" = c(
                   xtab_employment[["fisher.ts"]][["estimate"]][[1]],
                   xtab_gcse[["fisher.ts"]][["estimate"]][[1]],
                   xtab_gld[["fisher.ts"]][["estimate"]][[1]],
                   xtab_homelessness[["fisher.ts"]][["estimate"]][[1]],
                   xtab_stop_search[["fisher.ts"]][["estimate"]][[1]],
                   xtab_cla[["fisher.ts"]][["estimate"]][[1]],
                   xtab_restraint[["fisher.ts"]][["estimate"]][[1]],
                   xtab_talking_therapies[["fisher.ts"]][["estimate"]][[1]],
                   xtab_section_136[["fisher.ts"]][["estimate"]][[1]]
                 ),
                 "ci_low" = c(
                   xtab_employment[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_gcse[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_gld[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_homelessness[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_stop_search[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_cla[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_restraint[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_talking_therapies[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_section_136[["fisher.ts"]][["conf.int"]][[1]]
                 ),
                 "ci_upp" = c(
                   xtab_employment[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_gcse[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_gld[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_homelessness[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_stop_search[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_cla[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_restraint[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_talking_therapies[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_section_136[["fisher.ts"]][["conf.int"]][[2]]
                 )
)

# or_df$indicator <- factor(black_df$indicator, levels = c("Employment", "Good level of development at age 5", "Level 4+ GCSE Maths & English", "Children looked after","Police Stop and Search","Homeless or at risk of being homeless"))
            
rr_df <- rbind(rr_gld,
               rr_gcse,
               rr_employment,
               rr_therapies,
               rr_homelessness,
               rr_stop_search,
               rr_restraint,
               rr_section_136,
               rr_cla)

rr_df$short_name <- c("gld",
                      "gcse",
                      "employment",
                      "therapies",
                      "homeless",
                      "stop_search",
                      "restraint",
                      "section_136",
                      "cla")
```


```{r or_plot, eval = FALSE, include = FALSE}
# test rescaling below 1, horizontal orientation , without caption
bt_orange <- "#ff9000"
or_df_2 <- or_df

or_df_2$original_OR <- or_df_2$OR # keep original OR values

or_df_2 <- or_df_2[order(or_df_2$OR),] # order df from lowest to highest
or_df_2$indicator <- fct_inorder(or_df_2$indicator) # put levels in order they appear in df

reduction_factor <- 14 # set reduction factor
for(i in 1:nrow(or_df_2)){
  if(or_df_2$OR[i] < 1){ # expand values below 1
    or_df_2$OR[i] <- reduction_factor * (0 - (1 - or_df_2$OR[i]))
    or_df_2$ci_low[i] <- reduction_factor * (0 - (1 - or_df_2$ci_low[i]))
    or_df_2$ci_upp[i] <- reduction_factor * (0 - (1 - or_df_2$ci_upp[i]))
  }
  else{ # transform values above one
      or_df_2$OR[i] <- or_df_2$OR[i] - 1 
    or_df_2$ci_low[i] <- or_df_2$ci_low[i] - 1
    or_df_2$ci_upp[i] <- or_df_2$ci_upp[i] - 1
  }
}

ggplot(or_df_2, aes(indicator, OR)) +
  geom_hline(yintercept = 0, colour = bt_orange, size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_upp), width = 0.2) +
  scale_y_continuous(expand = c(0, 0), limits = c(reduction_factor * -1, reduction_factor), breaks = c((reduction_factor * -1) * 0.9, 0.5 * reduction_factor - reduction_factor, 0.75 * reduction_factor - reduction_factor, 0, 2, 4, 7, 11), labels = c(
    "10x less likely",
    "Half as likely",
    "3/4 as likely",
    "Just as likely",
    "3x more likely",
    "5x more likely",
    "8x more likely",
    "12x more likely")) +
  expand_limits(x = c(0,nrow(or_df) + 2)) + # for expanding discrete scale
  ylab("Likelihood of outcome compared to White ethnicity") +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_text(colour = "black"),
    axis.title.y = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    text = element_text(size = 12),
    axis.text = element_text( colour = "black"),
    plot.caption = element_text(face = "italic"),
    plot.title = element_text(size = 12)
  ) +
  annotate("segment", x = nrow(or_df) + 1, xend = nrow(or_df) + 1, y = reduction_factor/30, yend = reduction_factor * 0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(or_df) + 1.5, y = reduction_factor*.9 - (reduction_factor*0.1), label = "More likely", colour = "black", size = 3.5, hjust = 1) +
  annotate("segment", x = nrow(or_df) + 1, xend =  nrow(or_df) + 1, y = (reduction_factor/-30), yend = -1*reduction_factor*0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(or_df) + 1.5, y = -1*reduction_factor*0.9 + (reduction_factor*0.1), label = "Less likely", colour = "black", size = 3.5, hjust = 0) +
  #geom_text(size = 3, nudge_x = -0.3, nudge_y = 0, aes(x = indicator,label = paste("OR =", round(original_OR, 2)),hjust = 0)) +
  geom_text(size = 3, nudge_x = -0.35, nudge_y = 0, aes(x = indicator,label = paste(round(original_OR, 2),"x", sep=""),hjust = 0.5)) +
  ggtitle("The likelihood of outcomes for the Black population compared to \n the White population")
  #labs(caption = "Note. OR = Odds ratio; bars represent 95% confidence interval")

#ggsave(filename = "../images/or_plot.png", width = 10, height = 6)
```


```{r rr_plot, include = TRUE}
# test rescaling below 1, hrrizontal orientation , without caption
bt_orange <- "#ff9000"
rr_df_2 <- rr_df

rr_df_2$original_rr <- rr_df_2$rr # keep original rr values

rr_df_2 <- rr_df_2[order(rr_df_2$rr),] # order df from lowest to highest
rr_df_2$indicator <- fct_inorder(rr_df_2$indicator) # put levels in order they appear in df

reduction_factor <- ceiling(max(rr_df_2$ci_upp)) # set reduction factor
for(i in 1:nrow(rr_df_2)){
  if(rr_df_2$rr[i] < 1){ # expand values below 1
    rr_df_2$rr[i] <- reduction_factor * (0 - (1 - rr_df_2$rr[i]))
    rr_df_2$ci_low[i] <- reduction_factor * (0 - (1 - rr_df_2$ci_low[i]))
    rr_df_2$ci_upp[i] <- reduction_factor * (0 - (1 - rr_df_2$ci_upp[i]))
  }
  else{ # transform values above one
      rr_df_2$rr[i] <- rr_df_2$rr[i] - 1 
    rr_df_2$ci_low[i] <- rr_df_2$ci_low[i] - 1
    rr_df_2$ci_upp[i] <- rr_df_2$ci_upp[i] - 1
  }
}

#tiff("../images/lambeth_sms.tiff", units = "in", width = 10, height = 6, res = resolution)
ggplot(rr_df_2, aes(indicator, rr)) +
  geom_hline(yintercept = 0, colour = bt_orange, size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_upp), width = 0.2) +
  scale_y_continuous(expand = c(0, 0), limits = c(reduction_factor * -1, reduction_factor), breaks = c((reduction_factor * -1) * 0.9, 0.5 * reduction_factor - reduction_factor, 0.75 * reduction_factor - reduction_factor, 0, 2, 4, 7, 11), labels = c(
    ".1x",
    ".5x",
    ".75x",
    "1x",
    "3x",
    "5x",
    "8x",
    "12x")) +
  expand_limits(x = c(0,nrow(rr_df) + 2)) + # for expanding discrete scale
  ylab("Likelihood of outcome compared to White ethnicity") +
  coord_flip() +
  theme_bw() +
  theme(
    
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_text(colour = "black", size = 10),
    axis.title.y = element_blank(),
    #axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    text = element_text(size = 12),
    axis.text = element_text( colour = "black"),
    plot.caption = element_text(face = "italic"),
    plot.title = element_text(size = 10)
  ) +
  annotate("segment", x = nrow(rr_df) + 1, xend = nrow(rr_df) + 1, y = reduction_factor/30, yend = reduction_factor * 0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(rr_df) + 1.5, y = reduction_factor*.9 - (reduction_factor*0.15), label = "More likely", colour = "black", size = 3.5, hjust = 1) +
  annotate("segment", x = nrow(rr_df) + 1, xend =  nrow(rr_df) + 1, y = (reduction_factor/-30), yend = -1*reduction_factor*0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(rr_df) + 1.5, y = -1*reduction_factor*0.9 + (reduction_factor*0.15), label = "Less likely", colour = "black", size = 3.5, hjust = 0) +
  #geom_text(size = 3, nudge_x = -0.3, nudge_y = 0, aes(x = indicator,label = paste("rr =", round(original_rr, 2)),hjust = 0)) +
  geom_text(size = 3, nudge_x = -0.35, nudge_y = 0, aes(x = indicator,label = paste(round(original_rr, 2),"x", sep=""),hjust = 0.5)) +
  ggtitle("The likelihood of outcomes for the Black population compared to the White population") +
  labs(caption = "Note. Numbers represent relative risk ratios")
#dev.off()
#ggsave(filename = "../images/rr_plot.png", width = 10, height = 6)
```

To summarise the results:

* Black children were `r round(100 * (1 - rr_df$rr[which(rr_df$short_name == "gld")]), 2)`% less likely than White children to reach a Good Level of Development at age 5.
* Black 16-64 year olds were `r round(100 * (1 - rr_df$rr[which(rr_df$short_name == "employment")]), 2)`% less likely than White 16-64 year olds to be in employment.
* Black pupils were just as likely as White pupils to achieve at least Level 4 in GCSE Maths and English.
* Black individuals were `r round(100 * rr_df$rr[which(rr_df$short_name == "therapies")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "therapies")], 2)` times) more likely than White individuals to be moderately to severely depressed when they start Talking Therapies.
* Black individuals were just as likely as White individuals to be detained under Section 136 of the Mental Health Act.
* Black ward patients were `r round(100 * rr_df$rr[which(rr_df$short_name == "restraint")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "restraint")], 2)` times) more likely than White ward patients to be physically restrained.
* Black children were `r round(100 * rr_df$rr[which(rr_df$short_name == "cla")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "cla")], 2)` times) more likely than White children to be looked after the local authority.
* Black individuals were `r round(100 * rr_df$rr[which(rr_df$short_name == "stop_search")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "stop_search")], 2)` times) more likely than White individuals to be stopped and searched by Police.
* Black households were `r round(100 * rr_df$rr[which(rr_df$short_name == "homeless")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "homeless")], 2)` times) more likely than White households to be statutorily homeless and living in temporary accommodation.

```{r rr_table, include = FALSE}
# table with rrS and CIS

rr_df_3 <- rr_df[,-c(ncol(rr_df))] %>%
  mutate(
    rr = round(rr, 2),
    ci_low = round(ci_low, 2),
    ci_upp = round(ci_upp, 2)
  )
rr_df_3 <- rr_df_3[order(-c(rr_df_3$rr)),]

rr_df_3 %>% kable("html", escape = F, row.names = F, col.names = linebreak(c("Indicator", "Relative risk", "Lower confidence<br>interval (95%)", "Upper confidence<br>interval (95%)")), caption = "Relative risk and confidence intervals corresponding to the above plot") %>% kable_styling(full_width = F)
```


# Indicator breakdowns

The above results are broken down below. For each indicator, the number of individuals of each ethnicity is plotted. A percentage is also presented, which represents the number as a proportion of the total population of each ethnicity. 

## Children reaching a good level of development at age 5

In 2018-2019, 67.46% of Black children reached a Good Level of Development, compared to 77.98% of White children. Black children were `r round(100 * (1 - rr_df$rr[which(rr_df$short_name == "gld")]), 2)`% less likely than White children to reach a Good Level of Development at age 5.


```{r include = TRUE}
## good development
data <- read.csv("../data/lambeth_gld_2018_2019.csv")

total_data <- data
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

# set up values for line
var <- total_data$gld
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(total_data$ethnicity) == "Black")
rpos <- which(levels(total_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(total_data$percentage) - min(total_data$percentage),2) # calculate % difference

ggplot(total_data, aes(ethnicity, gld)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(gld))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Children reaching a Good Level of Development") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")
  
```

## Children looked after by local authority

In the 2018-2019 financial year, 0.75% of Black children were looked after by the local authority, compared to 0.28% of White children. Black children were `r round(100 * rr_df$rr[which(rr_df$short_name == "cla")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "cla")], 2)` times) more likely than White children to be looked after the local authority.


```{r include = TRUE}
# children looked after
data <- read.csv("../data/lambeth_cla_2019.csv")

total_data <- data
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

# set up values for line
var <- total_data$looked_after
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(total_data$ethnicity) == "Black")
rpos <- which(levels(total_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(total_data$percentage) - min(total_data$percentage),2) # calculate % difference

ggplot(total_data, aes(ethnicity, looked_after)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(looked_after))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Children looked after by the local authority") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```

## Pupils achieving Level 4+ in GCSE Maths and English

In the 2019/2020 academic year, 68.3% of Black pupils and 67.6% of White pupils achieved at least Level 4 in GCSE Maths and English. This difference was non-significant.

```{r include = TRUE}
data <- read.csv("../data/lambeth_gcse_2019_2020.csv")

# subset and rename
total_data <- data %>%
  subset(characteristic_gender == "Total") %>%
  rename(
    ethnicity = characteristic_Ethnic_major
  ) %>%
  subset(ethnicity == "BLACK" | ethnicity == "WHITE") %>%
  rename(gcse = t_l2basics_94,
         percentage = pt_l2basics_94)

total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

# ggplot(total_data, aes(ethnicity, percentage)) + 
#   geom_col(colour = "black", fill = "#ff9000", width = .5) +
#   scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
#   theme(panel.background = element_rect(fill = "white"),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.major.x = element_blank(),
#         axis.line = element_line(colour = "black")) +
#   geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
#   xlab("Ethnicity") + ylab("Percentage") +
#   ggtitle("Percentage of pupils achieving 4+ in GCSE Maths and English")

# set up values for line
var <- total_data$gcse
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(total_data$ethnicity) == "Black")
rpos <- which(levels(total_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(total_data$percentage) - min(total_data$percentage),2) # calculate % difference

ggplot(total_data, aes(ethnicity, gcse)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(gcse))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Pupils achieving 4+ in GCSE Maths and English") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```

## Employment

In 2020, the employment rate amongst Black 16-64 year olds was 71.5%, compared to 81.8% for White individuals. Black 16-64 year olds were `r round(100 * (1 - rr_df$rr[which(rr_df$short_name == "employment")]), 2)`% less likely than White 16-64 year olds to be in employment.


```{r include = TRUE}
# employment
data <- read.csv("../data/lambeth_employment_rate_march_2021_v2.csv")

# subset and organise data
total_data <- data %>%
  mutate(
    percentage = as.numeric(percentage),
    numerator = as.numeric(numerator),
    denominator = as.numeric(denominator)
  )
  
total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

# set up values for line
maxval <- max(total_data$numerator) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(total_data$ethnicity) == "Black")
rpos <- which(levels(total_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(total_data$numerator * 0.1) # amount to nudge labels

difference <- round(max(total_data$percentage) - min(total_data$percentage),2) # calculate % difference

ggplot(total_data, aes(ethnicity, numerator)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(numerator))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("16-64 year olds in employment") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")
  

```


## Percentage of households homeless or at risk of becoming homeless

In the 2020/21 financial year, 2.84% of Black households were assessed as statutorily homeless or at risk of becoming homeless, compared to 0.38% of White households. Black households were `r round(100 * rr_df$rr[which(rr_df$short_name == "homeless")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "homeless")], 2)` times) more likely than White households to be statutorily homeless or at risk of becoming homeless.


```{r include = TRUE}
# homelessness
data <- read.csv("../data/lambeth_stat_homeless_jun_2021.csv")

total_data <- data

total_data$ethnicity <- as.factor(total_data$ethnicity)
levels(total_data$ethnicity) <- c("Black","White")

# set up values for line
var <- total_data$homeless
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(total_data$ethnicity) == "Black")
rpos <- which(levels(total_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(total_data$percentage) - min(total_data$percentage),2) # calculate % difference

ggplot(total_data, aes(ethnicity, homeless)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(homeless))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Households statutorily homeless or at risk of becoming homeless") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")


```

## Individuals subject to detention per Section 136 of the Mental Health Act

In 2018-2019, the rate of individuals detained under Section 136 of the Mental Health act was 60 per 100,000 (0.06%) for Black individuals, compared to 40 per 100,000 (0.04%) for White individuals. There was no difference between Black and White individuals in Section 136 detention rate.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = as.factor(c("Black", "White")),
           "detained" = c(sect_136_df$black[1], sect_136_df$white[1]),
                                  "percentage" = c(round(100 * (sect_136_df$black[1] / sum(sect_136_df$black)), 3),
                                                      round(100 * (sect_136_df$white[1] / sum(sect_136_df$white)), 3)))
# plot_data <- as.data.frame(t(sect_136_df)) %>%
#   mutate(
#     ethnicity = as.factor(c("Black","White")),
#     percentage = 100 * (detained / sum(detained,`not detained`))
#   )
#   

# ggplot(plot_data, aes(ethnicity, per_100k)) + 
#   geom_col(colour = "black", fill = "#ff9000", width = .5) +
#   scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
#   theme(panel.background = element_rect(fill = "white"),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.major.x = element_blank(),
#         axis.line = element_line(colour = "black")) +
#   geom_label(aes(label = paste(round(per_100k,2), sep = ""))) +
#   xlab("Ethnicity") + ylab("Number per 100,000") +
#   ggtitle("Number of individuals detained via Section 136 per 100,000")

# set up values for line
var <- plot_data$detained
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(plot_data$ethnicity) == "Black")
rpos <- which(levels(plot_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(plot_data$percentage) - min(plot_data$percentage),3) # calculate % difference

ggplot(plot_data, aes(ethnicity, detained)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = detained)) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Individuals detained via Section 136") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```

## Individuals moderately to severely depressed on entering Talking Therapies

In 2017-2018, 65% of Black individuals were moderately to severely depressed before starting Talking Therapies, compared to 50% of White individuals. Black individuals were `r round(100 * rr_df$rr[which(rr_df$short_name == "therapies")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "therapies")], 2)` times) more likely than White individuals to be moderately to severely depressed when they start Talking Therapies.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = as.factor(c("Black", "White")),
                        "depressed" = c(talking_therapies_df$black[1], talking_therapies_df$white[1]),
                                     "percentage" = c(round(100 * (talking_therapies_df$black[1] / sum(talking_therapies_df$black)), 2), 
                                                      round(100 * (talking_therapies_df$white[1] / sum(talking_therapies_df$white)), 2)))

# ggplot(plot_data, aes(ethnicity, percentage)) + 
#   geom_col(colour = "black", fill = "#ff9000", width = .5) +
#   scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
#   theme(panel.background = element_rect(fill = "white"),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.major.x = element_blank(),
#         axis.line = element_line(colour = "black")) +
#   geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
#   xlab("Ethnicity") + ylab("Percentage") +
#   ggtitle("Percentage of individuals moderately/severely depressed \non entry to Talking Therapies")


# set up values for line
var <- plot_data$depressed
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(plot_data$ethnicity) == "Black")
rpos <- which(levels(plot_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(plot_data$percentage) - min(plot_data$percentage),3) # calculate % difference

ggplot(plot_data, aes(ethnicity, depressed)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(depressed))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Individuals moderately/severely depressed on entry to Talking Therapies") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```



## Individuals physically restrained on Lambeth Wards

In 2017-2018, 65% of Black Lambeth ward patients had physical restraint used on them, compared to 39% of White patients. Black ward patients were `r round(100 * rr_df$rr[which(rr_df$short_name == "restraint")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "restraint")], 2)` times) more likely than White ward patients to be physically restrained.


```{r include = TRUE}
plot_data <- data.frame("ethnicity" = as.factor(c("Black", "White")),
                        "restrained" = c(restraint_df$black[1], restraint_df$white[1]),
                                     "percentage" = c(round(100 * (restraint_df$black[1] / sum(restraint_df$black)), 2), 
                                                      round(100 * (restraint_df$white[1] / sum(restraint_df$white)), 2)))

# ggplot(plot_data, aes(ethnicity, percentage)) + 
#   geom_col(colour = "black", fill = "#ff9000", width = .5) +
#   scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
#   theme(panel.background = element_rect(fill = "white"),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.major.x = element_blank(),
#         axis.line = element_line(colour = "black")) +
#   geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
#   xlab("Ethnicity") + ylab("Percentage") +
#   ggtitle("Percentage of Lambeth ward patients subject to physical restraint")

# set up values for line
var <- plot_data$restrained
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(plot_data$ethnicity) == "Black")
rpos <- which(levels(plot_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(plot_data$percentage) - min(plot_data$percentage),3) # calculate % difference

ggplot(plot_data, aes(ethnicity, restrained)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(restrained))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Lambeth ward patients subject to physical restraint") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```

## Individuals subject to Police Stop and Search

In the period from September 2020 to August 2021, 9.49% of Black individuals in Lambeth were stopped and searched by Police, compared to % of White individuals. Black individuals were `r round(100 * rr_df$rr[which(rr_df$short_name == "stop_search")],0) - 100`% (i.e., `r round(rr_df$rr[which(rr_df$short_name == "stop_search")], 2)` times) more likely than White individuals to be stopped and searched by Police.


```{r include = TRUE}
plot_data <- data.frame("ethnicity" = as.factor(c("Black", "White")),
                        "stopped" = c(stop_search_df$Black[1], stop_search_df$White[1]),
                                     "percentage" = c(round(100 * (stop_search_df$Black[1] / sum(stop_search_df$Black)), 2), 
                                                      round(100 * (stop_search_df$White[1] / sum(stop_search_df$White)), 2)))

# ggplot(plot_data, aes(ethnicity, percentage)) + 
#   geom_col(colour = "black", fill = "#ff9000", width = .5) +
#   scale_y_continuous(limits =  c(0,20), breaks = seq(0,20,5), expand = c(0,0)) +
#   theme(panel.background = element_rect(fill = "white"),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.major.x = element_blank(),
#         axis.line = element_line(colour = "black")) +
#   geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
#   xlab("Ethnicity") + ylab("Percentage") +
#   ggtitle("Percentage of individuals subject to Police Stop and Search")

# set up values for line
var <- plot_data$stopped
maxval <- max(var) * 1.2
lowval <- maxval - (maxval * .02)
txtval <- maxval * 1.04
lpos <- which(levels(plot_data$ethnicity) == "Black")
rpos <- which(levels(plot_data$ethnicity) == "White")
mpos <- (lpos + rpos) / 2
line_df <- data.frame(a = c(lpos, lpos, rpos, rpos), b = c(lowval, maxval, maxval, lowval)) # df for line

nudge_value <- max(var * 0.1) # amount to nudge labels

difference <- round(max(plot_data$percentage) - min(plot_data$percentage),3) # calculate % difference

ggplot(plot_data, aes(ethnicity, stopped)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(label = comma, expand = c(0,0), limits = c(0, maxval * 1.15)) + 
  geom_line(data = line_df, aes(a, b)) +
  annotate("text", x = mpos, y = txtval, label = paste0("Difference = ", difference, "%")) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.caption = element_text(face = "italic"),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = scales::comma(stopped))) +
  geom_label(aes(label = paste0(round(percentage,2),"%")), nudge_y = -nudge_value) +

  #geom_label(aes(label = paste(numerator, "\n(",round(percentage,2),"%)", sep = ""))) +
  xlab("Ethnicity") + ylab("Number") +
  ggtitle("Individuals subject to Police Stop and Search") +
  labs(caption = "Note. Percentages represent the number as a proportion of the total population of each ethnicity")

```

# Authors

This document was produced by the Research Team at Black Thrive Global:

**Jolyon Miles-Wilson**

**Dr Celestin Okoroji**

Any questions, comments, and/or feedback on any aspect of this analysis are greatly appreciated. Please contact us at research@blackthrive.org, FAO Jolyon Miles-Wilson.

# Supporting information

The R code that produced this report is available on Github [here](https://github.com/BlackThrive/lambeth_sms). A separate methodology paper that provides more detail on the data and analysis procedure is available [here](https://github.com/BlackThrive/sms_methodology).

# Appendix

```{r include = TRUE, echo = FALSE}
sources_df <- data.frame("Indicator" = c("Children reaching a Good Level of Development at age 5",
                                        "Children looked after by local authority",
                                    "Pupils achieving at least Level 4 in GCSE Maths & English",
                                   
                                    "16-64 year olds in employment",
                                    "Households that are statutorily homeless or at risk of becoming homeless",
                                    "Individuals subject to detention per Section 136 of the Mental Health Act",
                                    "Individuals moderately to severely depressed prior to starting Talking Therapies",
                                    "Lambeth ward patients physically restrained",
                                    "Individuals subject to Police Stop and Search",
                                    "Lambeth adult population estimates",
                                    "Lambeth child population estimates"
                                    ),
                         "Date" = c("2018/19 academic year",
                                    "2018/19",
                                    "2019/20 academic year",
                                    "12 months to March 2021",
                                    "2020/2021 financial year",
                                    "2018/19",
                                    "2017/18",
                                    "2017/18",
                                    "12 months to August 2021",
                                    "2021",
                                    "2019"
                                    ),
                    "Source" = c("Lambeth Council, Education Research and Statistics Department",
                                 "[Children looked after in England including adoption](https://www.gov.uk/government/statistics/children-looked-after-in-england-including-adoption-2018-to-2019)",
                                 "[Key Stage 4 performance](https://explore-education-statistics.service.gov.uk/find-statistics/key-stage-4-performance-revised#dataDownloads-1)",
                                 "[Annual Population Survey (NOMIS, Office for National Statistics)](https://www.nomisweb.co.uk/datasets/apsnew)",
                                 "[Live tables on homelessness; Detailed local authority level tables](https://www.gov.uk/government/statistical-data-sets/live-tables-on-homelessness#homelessness-summary-local-authority-level-tables)",
                                 "EPJS, South London and Maudsley NHS Foundation Trust",
                                 "IAPTUS, South London and Maudsley NHS Foundation Trust",
                                 "DATIX, South London and Maudsley NHS Foundation Trust",
                                 "[Metropolitan Police Stop and Search Dashboard Data](https://data.london.gov.uk/dataset/mps-stop-and-search-public-dashboard-data)",
                                 "[Annual Population Survey](https://www.nomisweb.co.uk/datasets/apsnew)",
                                 "[Greater London Authority Ethnic group population projections](https://data.london.gov.uk/dataset/ethnic-group-population-projections)"
                                 ),
                    "Note" = c("Analyses based on crosstabulations derived from data sourced by Lambeth Public Health",
                                  "",
                                  "",
                                  "",
                                  "",
                                  "Analyses based on crosstabulations derived from data sourced by Lambeth Public Health",
                                  "Analyses based on crosstabulations derived from data sourced by Lambeth Public Health",
                                  "Analyses based on crosstabulations derived from data sourced by Lambeth Public Health",
                                  "",
                                  "",
                                  "")
)

sources_df %>% kbl() %>%
  kable_styling(full_width = F)
```

