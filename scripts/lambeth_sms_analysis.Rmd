---
title: |
  | Black Thrive Shared Measurement System
  | Lambeth
author: "Jolyon Miles-Wilson"
date: "05/10/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```


```{r}
library(gmodels)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(epitools)
library(showtext)
showtext_auto(enable = F)
font_add("archivo",
         regular = "../fonts/static/Archivo/Archivo-Regular.ttf",
         italic = "../fonts/static/Archivo/Archivo-Italic.ttf",
         bold = "../fonts/static/Archivo/Archivo-Bold.ttf",
         bolditalic = "../fonts/static/Archivo/Archivo-BoldItalic.ttf"
)
resolution <- 1000
showtext_opts(dpi = resolution)
```




```{r gld}
# input stats from existing SMS
b <- data.frame("black" = c(807, 380))
w <- data.frame("white" = c(493, 101))
df <- cbind(b,w)
rownames(df) <- c("good dev","no good dev")
mat <- as.matrix(df)

gld_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_gld <- xtab # save xtab for later
```


```{r gcse}
b <- data.frame("black" = c(654, 494))
w <- data.frame("white" = c(140, 83))
df <- df <- cbind(b,w)
rownames(df) <- c("Level 4+","Not level 4+")
mat <- as.matrix(df)

gcse_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_gcse <- xtab # save xtab for later

```



```{r employment}
b <- data.frame("black" = c(30800,20534))
w <- data.frame("white" = c(117700,20771))
df <- cbind(b,w)
rownames(df) <- c("employed","not employed")
mat <- as.matrix(df)
chisq.test(df)

employment_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_employment <- xtab # save xtab for later
```




```{r therapies}
b <- data.frame("black" = c(1020,550))
w <- data.frame("white" = c(1563,1563))
df <- cbind(b,w)
rownames(df) <- c("sev dep on entry","not sev dep on entry")
mat <- as.matrix(df)


talking_therapies_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_talking_therapies <- xtab # save xtab for later 

```


```{r sect_136}
b <- data.frame("black" = c(38,63296))
w <- data.frame("white" = c(44,109956))
df <- cbind(b,w)
rownames(df) <- c("detained","not detained")
mat <- as.matrix(df)

sect_136_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_section_136 <- xtab # save xtab for later
```



```{r restraint}
b <- data.frame("black" = c(228,123))
w <- data.frame("white" = c(70,110))
df <- cbind(b,w)
rownames(df) <- c("restraint","not restraint")
mat <- as.matrix(df)

restraint_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_restraint <- xtab # save xtab for later
```


```{r cla}
b <- data.frame("black" = c(280,30155))
w <- data.frame("white" = c(57,14943))
df <- cbind(b,w)
rownames(df) <- c("looked after","not looked after")
mat <- as.matrix(df)

cla_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_cla <- xtab # save xtab for later
```


```{r temp_accomm}
b <- data.frame("black" = c(1169,31304))
w <- data.frame("white" = c(166,55168))
df <- cbind(b,w)
rownames(df) <- c("in temp accomm","not in temp accomm")
mat <- as.matrix(df)

temp_accomm_df <- df # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_temp_accomm <- xtab # save xtab for later
```



```{r stop_search}
# stop and search
data <- read.csv("../data/Stops_LDS_Extract_12MonthsToEnd_202109.csv")

data <- subset(data, Borough.of.Stop == "Lambeth") # subset to Lambeth

# officer-defined ethnicity
appearance_freq_data <- data %>%
  group_by(EA.Group) %>%
  summarise(
    stopped = n() # count frequencies
  )

appearance_freq_data <- appearance_freq_data %>%
  mutate(
    pop = c(6500, 54600, 26700, 177400), # Lambeth population estimates taken from APS 12 months to Jun 2021
    percentage = 100 * (stopped/pop),
    not_stopped = pop - stopped
    ) %>%
  rename(
    ethnicity = EA.Group
  )

appearance_freq_data <- as.data.frame(appearance_freq_data)
row.names(appearance_freq_data) <- appearance_freq_data$ethnicity

black <- data.frame("Black" = c("stopped" = appearance_freq_data["Black", "stopped"], "not_stopped" = appearance_freq_data["Black", "not_stopped"]))

white <- data.frame("White" = c("stopped" = appearance_freq_data["White", "stopped"], "not_stopped" = appearance_freq_data["White", "not_stopped"]))

bw_mat <- as.matrix(cbind(black, white))

stop_search_df <- as.data.frame(bw_mat) # save df

# run analysis
xtab <- CrossTable(mat, chisq = T, fisher = T, expected = T)
xtab_stop_search <- xtab # save xtab for later

plot_data <- subset(appearance_freq_data, ethnicity == "Black" | ethnicity == "White")

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,20), breaks = seq(0,20,5), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage of individuals \n subject to Police Stop and Search")

```

# Results


```{r or_df, include = FALSE}
# dataframe for odds ratios and cis

or_df <- data.frame("indicator" = c("Employment (2020)", 
                                 "Level 4+ GCSE Maths & English (2018)", 
                                 "Good level of development at age 5 (2017-2018)",
                                 "Statutorily homeless and in temporary accommodation (2018)",
                                 "Police Stop and Search (2020-2021)",
                                 "Children looked after by local authority (2018)",
                                 "Physical restraint in Lambeth wards (2017-2018)",
                                 "Mod./Sev. depressed on entry to Talking Therapies (2017-2018)",
                                 "Section 136 detentions (2018-2019"),
                 "OR" = c(
                   xtab_employment[["fisher.ts"]][["estimate"]][[1]],
                   xtab_gcse[["fisher.ts"]][["estimate"]][[1]],
                   xtab_gld[["fisher.ts"]][["estimate"]][[1]],
                   xtab_temp_accomm[["fisher.ts"]][["estimate"]][[1]],
                   xtab_stop_search[["fisher.ts"]][["estimate"]][[1]],
                   xtab_cla[["fisher.ts"]][["estimate"]][[1]],
                   xtab_restraint[["fisher.ts"]][["estimate"]][[1]],
                   xtab_talking_therapies[["fisher.ts"]][["estimate"]][[1]],
                   xtab_section_136[["fisher.ts"]][["estimate"]][[1]]
                 ),
                 "ci_low" = c(
                   xtab_employment[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_gcse[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_gld[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_temp_accomm[["fisher.ts"]][["conf.int"]][[1]], 
                   xtab_stop_search[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_cla[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_restraint[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_talking_therapies[["fisher.ts"]][["conf.int"]][[1]],
                   xtab_section_136[["fisher.ts"]][["conf.int"]][[1]]
                 ),
                 "ci_upp" = c(
                   xtab_employment[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_gcse[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_gld[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_temp_accomm[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_stop_search[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_cla[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_restraint[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_talking_therapies[["fisher.ts"]][["conf.int"]][[2]],
                   xtab_section_136[["fisher.ts"]][["conf.int"]][[2]]
                 )
)

# or_df$indicator <- factor(black_df$indicator, levels = c("Employment", "Good level of development at age 5", "Level 4+ GCSE Maths & English", "Children looked after","Police Stop and Search","Homeless or at risk of being homeless"))
            
```


The plot below shows that the Black population in Lambeth experience worse outcomes than the White population on nearly every indicator measured. To summarise: 
* Black individuals are 29% less likely than White individuals to be in employment.
* Black children are over 18% less likely than White children to reach a Good Level of Development at age 5.
* Black pupils are just as likely as White pupils to achieve at least Level 4 in GCSE Maths and English.
* Black individuals are 30% more likely than White individuals to be moderately to severely depressed when they start Talking Therapies.
* Black individuals are just as likely as White individuals to be detained under Section 136 of the Mental Health Act.
* Black ward patients are 67% more likely than White ward patients to be physically restrained.
* Black children are over 2.4 times more likely as White children to be looked after the local authority.
* Black individuals are nearly seven times more likely than White individuals to be stopped and searched by Police.
* Black households are twelve times as likely as White households to be homeless and living in temporary accommodation.

```{r or_plot, include = FALSE}
# test rescaling below 1, horizontal orientation , without caption
bt_orange <- "#ff9000"
or_df_2 <- or_df

or_df_2$original_OR <- or_df_2$OR # keep original OR values

or_df_2 <- or_df_2[order(or_df_2$OR),] # order df from lowest to highest
or_df_2$indicator <- fct_inorder(or_df_2$indicator) # put levels in order they appear in df

reduction_factor <- 14 # set reduction factor
for(i in 1:nrow(or_df_2)){
  if(or_df_2$OR[i] < 1){ # expand values below 1
    or_df_2$OR[i] <- reduction_factor * (0 - (1 - or_df_2$OR[i]))
    or_df_2$ci_low[i] <- reduction_factor * (0 - (1 - or_df_2$ci_low[i]))
    or_df_2$ci_upp[i] <- reduction_factor * (0 - (1 - or_df_2$ci_upp[i]))
  }
  else{ # transform values above one
      or_df_2$OR[i] <- or_df_2$OR[i] - 1 
    or_df_2$ci_low[i] <- or_df_2$ci_low[i] - 1
    or_df_2$ci_upp[i] <- or_df_2$ci_upp[i] - 1
  }
}

ggplot(or_df_2, aes(indicator, OR)) +
  geom_hline(yintercept = 0, colour = bt_orange, size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_upp), width = 0.2) +
  scale_y_continuous(expand = c(0, 0), limits = c(reduction_factor * -1, reduction_factor), breaks = c((reduction_factor * -1) * 0.9, 0.5 * reduction_factor - reduction_factor, 0.75 * reduction_factor - reduction_factor, 0, 2, 4, 7, 11), labels = c(
    "10x less likely",
    "Half as likely",
    "3/4 as likely",
    "Just as likely",
    "3x more likely",
    "5x more likely",
    "8x more likely",
    "12x more likely")) +
  expand_limits(x = c(0,nrow(or_df) + 2)) + # for expanding discrete scale
  ylab("Likelihood of outcome compared to White ethnicity") +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_text(colour = "black"),
    axis.title.y = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    text = element_text(family = "archivo", size = 12),
    axis.text = element_text(family = "archivo", colour = "black"),
    plot.caption = element_text(face = "italic"),
    plot.title = element_text(size = 12)
  ) +
  annotate("segment", x = nrow(or_df) + 1, xend = nrow(or_df) + 1, y = reduction_factor/30, yend = reduction_factor * 0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(or_df) + 1.5, y = reduction_factor*.9 - (reduction_factor*0.1), label = "More likely", colour = "black", size = 3.5, hjust = 1) +
  annotate("segment", x = nrow(or_df) + 1, xend =  nrow(or_df) + 1, y = (reduction_factor/-30), yend = -1*reduction_factor*0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(or_df) + 1.5, y = -1*reduction_factor*0.9 + (reduction_factor*0.1), label = "Less likely", colour = "black", size = 3.5, hjust = 0) +
  #geom_text(size = 3, nudge_x = -0.3, nudge_y = 0, aes(x = indicator,label = paste("OR =", round(original_OR, 2)),hjust = 0)) +
  geom_text(size = 3, nudge_x = -0.35, nudge_y = 0, aes(x = indicator,label = paste(round(original_OR, 2),"x", sep=""),hjust = 0.5)) +
  ggtitle("The likelihood of outcomes for the Black population compared to \n the White population")
  #labs(caption = "Note. OR = Odds ratio; bars represent 95% confidence interval")

#ggsave(filename = "../images/or_plot.png", width = 10, height = 6)
```


```{r rr_conversion}
# function for converting ORs to RRs
# convert_to_rr <- function(or, ref_prob){
#   rr <- or / (1 - ref_prob + (ref_prob * or))
#   return(rr)
# }
# ref_prob <- talking_therapies_df$white[1] / sum(talking_therapies_df$white)

rr_from_df <- function(df, name){
  # function takes dfs made earlier, transforms in matrices, and creates risk
  # ratios and associated confidence intervals
  # 'name' is the name of the indicator
  mat <- matrix(c(df[2,2],
                  df[2,1],
                  df[1,2],
                  df[1,1]), 2, 2)
  df_out <- data.frame("indicator" = name,
                     "rr" = riskratio(mat)[["measure"]][2,1],
                     "ci_low" = riskratio(mat)[["measure"]][2,2],
                     "ci_upp" = riskratio(mat)[["measure"]][2,3])
  return(df_out)
}

rr_gld <- rr_from_df(gld_df, "Good level of development at age 5 (2017-2018)")
rr_gcse <- rr_from_df(gcse_df, "Level 4+ GCSE Maths & English (2018)")
rr_employment <- rr_from_df(employment_df, "Employment rate (2020)")
rr_therapies <- rr_from_df(talking_therapies_df, "Mod./Sev. depressed on entry to Talking Therapies (2017-2018)")
rr_temp_accomm <- rr_from_df(temp_accomm_df, "Statutorily homeless and living in temporary accommodation (2018)")
rr_stop_search <- rr_from_df(stop_search_df, "Police Stop and Search (2020-2021)")
rr_restraint <- rr_from_df(restraint_df, "Physical restraint in Lambeth wards (2017-2018)")
rr_section_136 <- rr_from_df(sect_136_df, "Section 136 detentions (2018-2019)")
rr_cla <- rr_from_df(cla_df, "Children looked after by local authority (2018)")

rr_df <- rbind(rr_gld,
               rr_gcse,
               rr_employment,
               rr_therapies,
               rr_temp_accomm,
               rr_stop_search,
               rr_restraint,
               rr_section_136,
               rr_cla)

```


```{r rr_plot, include = TRUE}
# test rescaling below 1, hrrizontal orientation , without caption
bt_orange <- "#ff9000"
rr_df_2 <- rr_df

rr_df_2$original_rr <- rr_df_2$rr # keep original rr values

rr_df_2 <- rr_df_2[order(rr_df_2$rr),] # order df from lowest to highest
rr_df_2$indicator <- fct_inorder(rr_df_2$indicator) # put levels in order they appear in df

reduction_factor <- 14 # set reduction factor
for(i in 1:nrow(rr_df_2)){
  if(rr_df_2$rr[i] < 1){ # expand values below 1
    rr_df_2$rr[i] <- reduction_factor * (0 - (1 - rr_df_2$rr[i]))
    rr_df_2$ci_low[i] <- reduction_factor * (0 - (1 - rr_df_2$ci_low[i]))
    rr_df_2$ci_upp[i] <- reduction_factor * (0 - (1 - rr_df_2$ci_upp[i]))
  }
  else{ # transform values above one
      rr_df_2$rr[i] <- rr_df_2$rr[i] - 1 
    rr_df_2$ci_low[i] <- rr_df_2$ci_low[i] - 1
    rr_df_2$ci_upp[i] <- rr_df_2$ci_upp[i] - 1
  }
}

#tiff("../images/test_high.tiff", units = "in", width = 10, height = 6, res = resolution)
ggplot(rr_df_2, aes(indicator, rr)) +
  geom_hline(yintercept = 0, colour = bt_orange, size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_upp), width = 0.2) +
  scale_y_continuous(expand = c(0, 0), limits = c(reduction_factor * -1, reduction_factor), breaks = c((reduction_factor * -1) * 0.9, 0.5 * reduction_factor - reduction_factor, 0.75 * reduction_factor - reduction_factor, 0, 2, 4, 7, 11), labels = c(
    "10x less likely",
    "Half as likely",
    "3/4 as likely",
    "Just as likely",
    "3x more likely",
    "5x more likely",
    "8x more likely",
    "12x more likely")) +
  expand_limits(x = c(0,nrow(rr_df) + 2)) + # for expanding discrete scale
  ylab("Likelihood of outcome compared to White ethnicity") +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.x = element_text(colour = "black"),
    axis.title.y = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    text = element_text(family = "archivo", size = 12),
    axis.text = element_text(family = "archivo", colour = "black"),
    plot.caption = element_text(face = "italic"),
    plot.title = element_text(size = 12)
  ) +
  annotate("segment", x = nrow(rr_df) + 1, xend = nrow(rr_df) + 1, y = reduction_factor/30, yend = reduction_factor * 0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(rr_df) + 1.5, y = reduction_factor*.9 - (reduction_factor*0.1), label = "More likely", colour = "black", size = 3.5, hjust = 1) +
  annotate("segment", x = nrow(rr_df) + 1, xend =  nrow(rr_df) + 1, y = (reduction_factor/-30), yend = -1*reduction_factor*0.9, arrow = arrow(angle = 45), size = 1) +
  geom_text(x = nrow(rr_df) + 1.5, y = -1*reduction_factor*0.9 + (reduction_factor*0.1), label = "Less likely", colour = "black", size = 3.5, hjust = 0) +
  #geom_text(size = 3, nudge_x = -0.3, nudge_y = 0, aes(x = indicator,label = paste("rr =", round(original_rr, 2)),hjust = 0)) +
  geom_text(size = 3, nudge_x = -0.35, nudge_y = 0, aes(x = indicator,label = paste(round(original_rr, 2),"x", sep=""),hjust = 0.5)) +
  ggtitle("The likelihood of outcomes for the Black population compared to \nthe White population")
  #labs(caption = "Note. rr = Odds ratio; bars represent 95% confidence interval")
#dev.off()
#ggsave(filename = "../images/rr_plot.png", width = 10, height = 6)
```

```{r rr_table, include = FALSE}
# table with rrS and CIS

rr_df_3 <- rr_df %>%
  mutate(
    rr = round(rr, 2),
    ci_low = round(ci_low, 2),
    ci_upp = round(ci_upp, 2)
  )
rr_df_3 <- rr_df_3[order(-c(rr_df_3$rr)),]

rr_df_3 %>% kable("html", escape = F, row.names = F, col.names = linebreak(c("Indicator", "Relative risk", "Lower confidence<br>interval (95%)", "Upper confidence<br>interval (95%)")), caption = "Relative risk and confidence intervals corresponding to the above plot") %>% kable_styling(full_width = F)
```


# Percentage breakdowns

The above results are broken down into percentages and rates below.

## Employment

In 2020, the employment rate amongst Black 16-64 year olds was 60%, compared to 85% for White individuals.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (employment_df$black[1] / sum(employment_df$black)), 2), 
                                                      round(100 * (employment_df$white[1] / sum(employment_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = bt_orange, width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(colour = "black"),
        axis.title = element_text(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of 16-64 year olds in employment")
```

## Children reaching a good level of development at age 5

In 2017-2018, 68% of Black children reached a Good Level of Development, compared to 83% of White children.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (gld_df$black[1] / sum(gld_df$black)), 2), 
                                                      round(100 * (gld_df$white[1] / sum(gld_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(fill = "#ff9000", colour = "black", width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(colour = "black"),
        axis.title = element_text(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of children reaching a Good Level of Development")
```

## Pupils achieving Level 4+ in GCSE Maths and English

In 2018, 57% of Black pupils and 63% of White pupils achieved at least Level 4 in GCSE Maths and English. This difference was non-significant.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (gcse_df$black[1] / sum(gcse_df$black)), 2), 
                                                      round(100 * (gcse_df$white[1] / sum(gcse_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2),"%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of pupils achieving 4+ in GCSE Maths and English")
```

## Individuals subject to detention per Section 136 of the Mental Health Act

In 2018-2019, the rate of individuals detained under Section 136 of the Mental Health act was 60 per 100,000 for Black individuals, compared to 40 per 100,000 for White individuals.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "per_100k" = c(round(100000 * (sect_136_df$black[1] / sum(sect_136_df$black)), 0), 
                                                      round(100000 * (sect_136_df$white[1] / sum(sect_136_df$white)), 0)))

ggplot(plot_data, aes(ethnicity, per_100k)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(per_100k,2), sep = ""))) +
  xlab("Ethnicity") + ylab("Number per 100,000") +
  ggtitle("Number of individuals detained via Section 136 per 100,000")

```

## Individuals moderately to severely depressed on entering Talking Therapies

In 2017-2018, 65% of Black individuals were moderately to severely depressed before starting Talking Therapies, compared to 50% of White individuals.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (talking_therapies_df$black[1] / sum(talking_therapies_df$black)), 2), 
                                                      round(100 * (talking_therapies_df$white[1] / sum(talking_therapies_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of individuals moderately/severely depreseed \non entry to Talking Therapies")

```

## Children looked after by local authority

In 2017-2018, 0.92% of Black children were looked after by the local authority, compared to 0.38% of White children.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (cla_df$black[1] / sum(cla_df$black)), 2), 
                                                      round(100 * (cla_df$white[1] / sum(cla_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,2), breaks = seq(0,2,1), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of children looked after by the local authority")

```

## Individuals physically restrained on Lambeth Wards

In 2017-2018, 65% of Black Lambeth ward patients had physical restraint used on them, compared to 39% of White patients.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (restraint_df$black[1] / sum(restraint_df$black)), 2), 
                                                      round(100 * (restraint_df$white[1] / sum(restraint_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,100), breaks = seq(0,100,10), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of Lambeth ward patients \nsubject to physical restraint")

```

## Individuals subject to Police Stop and Search

In the period from September 2020 to August 2021, 15% of Black individuals in Lambeth were stopped and searched by Police, compared to 2% of White individuals.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (stop_search_df$Black[1] / sum(stop_search_df$Black)), 2), 
                                                      round(100 * (stop_search_df$White[1] / sum(stop_search_df$White)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,20), breaks = seq(0,20,5), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of individuals subject to Police Stop and Search")

```

## Percentage of households homeless or in temporary accommodation

In 2018, 3.6% of Black households were statutorily homeless and in temporary accommodation, compared to 0.3% of White households.

```{r include = TRUE}
plot_data <- data.frame("ethnicity" = c("Black", "White"),
                                     "percentage" = c(round(100 * (temp_accomm_df$black[1] / sum(temp_accomm_df$black)), 2), 
                                                      round(100 * (temp_accomm_df$white[1] / sum(temp_accomm_df$white)), 2)))

ggplot(plot_data, aes(ethnicity, percentage)) + 
  geom_col(colour = "black", fill = "#ff9000", width = .5) +
  scale_y_continuous(limits =  c(0,5), breaks = seq(0,5,1), expand = c(0,0)) +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_label(aes(label = paste(round(percentage,2), "%", sep = ""))) +
  xlab("Ethnicity") + ylab("Percentage") +
  ggtitle("Percentage of households in temporary accommodation")

```
